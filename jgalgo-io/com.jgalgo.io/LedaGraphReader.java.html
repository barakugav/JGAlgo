<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LedaGraphReader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JGAlgo - IO</a> &gt; <a href="index.source.html" class="el_package">com.jgalgo.io</a> &gt; <span class="el_source">LedaGraphReader.java</span></div><h1>LedaGraphReader.java</h1><pre class="source lang-java linenums">/*-
 * Copyright 2023 Barak Ugav
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.jgalgo.io;

import java.io.BufferedReader;
import java.io.Reader;
import java.util.Iterator;
import java.util.List;
import java.util.Objects;
import java.util.function.ObjIntConsumer;
import java.util.function.Supplier;
import com.jgalgo.graph.Graph;
import com.jgalgo.graph.IWeights;
import com.jgalgo.graph.IWeightsBool;
import com.jgalgo.graph.IWeightsByte;
import com.jgalgo.graph.IWeightsChar;
import com.jgalgo.graph.IWeightsDouble;
import com.jgalgo.graph.IWeightsFloat;
import com.jgalgo.graph.IWeightsInt;
import com.jgalgo.graph.IWeightsLong;
import com.jgalgo.graph.IWeightsObj;
import com.jgalgo.graph.IWeightsShort;
import com.jgalgo.graph.IntGraphBuilder;
import com.jgalgo.graph.IntGraphFactory;
import com.jgalgo.graph.Weights;

/**
 * Read a graph in 'LEDA' format.
 *
 * &lt;p&gt;
 * The &lt;a href=https://www.algorithmic-solutions.info/leda_guide/graphs/leda_native_graph_fileformat.html&gt;LEDA
 * format&lt;/a&gt; is a simple format for both directed and undirected graphs, used by the &lt;a
 * href=https://en.wikipedia.org/wiki/Library_of_Efficient_Data_types_and_Algorithms&gt;LEDA&lt;/a&gt; library. Vertices are
 * numbered from 1 to n, and edges are numbered from 1 to m. It support a single weight for vertices and a single weight
 * for edges. The weights can be any primitive, or a string.
 *
 * &lt;p&gt;
 * When the reader reads a graph from a file with weights, it will be added to the graph as a {@link Weights} object
 * with key {@code &quot;weight&quot;}, for both vertices and edges. The weights are later available view
 * {@link Graph#getVerticesWeights(String)}. To change the weights key, use {@link #setVerticesWeightsKey(String)} and
 * {@link #setEdgesWeightsKey(String)}.
 *
 * @see    LedaGraphWriter
 * @author Barak Ugav
 */
public class LedaGraphReader extends GraphIoUtils.AbstractIntGraphReader {

<span class="fc" id="L61">	private String verticesWeightsKey = &quot;weight&quot;;</span>
<span class="fc" id="L62">	private String edgesWeightsKey = &quot;weight&quot;;</span>

	/**
	 * Create a new reader.
	 */
<span class="fc" id="L67">	public LedaGraphReader() {}</span>

	/**
	 * Sets the key of the vertices weights that will be read.
	 *
	 * &lt;p&gt;
	 * When the reader reads a graph with vertices weights, {@link Weights} will be added to the built graph. By
	 * default, the weights will be added with key &quot;weight&quot;. Use this method to specify a different key.
	 *
	 * @param verticesWeightsKey the key of the vertices weights that will be read
	 */
	public void setVerticesWeightsKey(String verticesWeightsKey) {
<span class="fc" id="L79">		this.verticesWeightsKey = Objects.requireNonNull(verticesWeightsKey);</span>
<span class="fc" id="L80">	}</span>

	/**
	 * Sets the key of the edges weights that will be read.
	 *
	 * &lt;p&gt;
	 * When the reader reads a graph with edges weights, {@link Weights} will be added to the built graph. By default,
	 * the weights will be added with key &quot;weight&quot;. Use this method to specify a different key.
	 *
	 * @param edgesWeightsKey the key of the edges weights that will be read
	 */
	public void setEdgesWeightsKey(String edgesWeightsKey) {
<span class="fc" id="L92">		this.edgesWeightsKey = Objects.requireNonNull(edgesWeightsKey);</span>
<span class="fc" id="L93">	}</span>

	@Override
	IntGraphBuilder readIntoBuilderImpl(Reader reader) {
<span class="fc" id="L97">		BufferedReader br = GraphIoUtils.bufferedReader(reader);</span>
<span class="fc" id="L98">		Iterator&lt;String&gt; lineIter = GraphIoUtils.lines(br, true).iterator();</span>
<span class="fc" id="L99">		Supplier&lt;String&gt; next = () -&gt; {</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">			while (lineIter.hasNext()) {</span>
<span class="fc" id="L101">				String line = lineIter.next();</span>
<span class="fc bfc" id="L102" title="All 4 branches covered.">				if (!line.isEmpty() &amp;&amp; !line.startsWith(&quot;#&quot;))</span>
<span class="fc" id="L103">					return line;</span>
<span class="fc" id="L104">			}</span>
<span class="fc" id="L105">			return null;</span>
		};

<span class="fc" id="L108">		String line1 = next.get();</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">		if (line1 == null)</span>
<span class="fc" id="L110">			throw new IllegalArgumentException(&quot;Leda file format: empty file&quot;);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">		if (!line1.equals(&quot;LEDA.GRAPH&quot;))</span>
<span class="fc" id="L112">			throw new IllegalArgumentException(&quot;Leda file format: first non-comment line must equals LEDA.GRAPH&quot;);</span>

<span class="fc" id="L114">		String verticesWeightsStr = next.get();</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">		if (verticesWeightsStr == null)</span>
<span class="fc" id="L116">			throw new IllegalArgumentException(&quot;Leda file format: invalid header&quot;);</span>
<span class="fc" id="L117">		Class&lt;?&gt; verticesWeightsType = ledaTypeStrToClass(verticesWeightsStr);</span>

<span class="fc" id="L119">		String edgesWeightsStr = next.get();</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">		if (edgesWeightsStr == null)</span>
<span class="fc" id="L121">			throw new IllegalArgumentException(&quot;Leda file format: invalid header&quot;);</span>
<span class="fc" id="L122">		Class&lt;?&gt; edgesWeightsType = ledaTypeStrToClass(edgesWeightsStr);</span>

<span class="fc" id="L124">		String directedOrUndirected = next.get();</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">		if (directedOrUndirected == null)</span>
<span class="fc" id="L126">			throw new IllegalArgumentException(&quot;Leda file format: invalid header&quot;);</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">		if (!List.of(&quot;-1&quot;, &quot;-2&quot;).contains(directedOrUndirected))</span>
<span class="fc" id="L128">			throw new IllegalArgumentException(&quot;Leda file format: 4th non-comment line must equals -1 or -2. &quot;</span>
					+ &quot;-1 is Directed graph. -2 is Undirected graph.&quot;);
<span class="fc" id="L130">		boolean directed = &quot;-1&quot;.equals(directedOrUndirected);</span>
<span class="fc" id="L131">		IntGraphBuilder builder = IntGraphFactory.newInstance(directed).allowSelfEdges().newBuilder();</span>

<span class="fc" id="L133">		IWeights&lt;?&gt; verticesWeights = null;</span>
<span class="fc" id="L134">		IWeights&lt;?&gt; edgesWeights = null;</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">		if (verticesWeightsType != null)</span>
<span class="fc" id="L136">			verticesWeights = (IWeights&lt;?&gt;) builder.addVerticesWeights(verticesWeightsKey, verticesWeightsType);</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">		if (edgesWeightsType != null)</span>
<span class="fc" id="L138">			edgesWeights = (IWeights&lt;?&gt;) builder.addEdgesWeights(edgesWeightsKey, edgesWeightsType);</span>
<span class="fc" id="L139">		ObjIntConsumer&lt;String&gt; verticesWeightsReader = weightsReader(verticesWeights);</span>
<span class="fc" id="L140">		ObjIntConsumer&lt;String&gt; edgesWeightsReader = weightsReader(edgesWeights);</span>

<span class="fc" id="L142">		String verticesNumLine = next.get();</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">		if (verticesNumLine == null)</span>
<span class="fc" id="L144">			throw new IllegalArgumentException(&quot;invalid nodes section&quot;);</span>
		final int n;
		try {
<span class="fc" id="L147">			n = Integer.parseInt(verticesNumLine);</span>
<span class="fc" id="L148">		} catch (NumberFormatException e) {</span>
<span class="fc" id="L149">			throw new IllegalArgumentException(&quot;invalid nodes section&quot;);</span>
<span class="fc" id="L150">		}</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">		if (n &lt; 0)</span>
<span class="fc" id="L152">			throw new IllegalArgumentException(&quot;invalid nodes section. num nodes must be &gt;= 0&quot;);</span>

<span class="fc bfc" id="L154" title="All 2 branches covered.">		for (int v = 1; v &lt;= n; v++) {</span>
<span class="fc" id="L155">			String line = next.get();</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">			if (line == null)</span>
<span class="fc" id="L157">				throw new IllegalArgumentException(&quot;Expected more node lines&quot;);</span>
<span class="fc bfc" id="L158" title="All 4 branches covered.">			if (!line.startsWith(&quot;|{&quot;) || !line.endsWith(&quot;}|&quot;))</span>
<span class="fc" id="L159">				throw new IllegalArgumentException(&quot;node line error. Expected '|{weight}|'&quot;);</span>
<span class="fc" id="L160">			String weight = line.substring(2, line.length() - 2);</span>

<span class="fc" id="L162">			builder.addVertex(v);</span>
<span class="fc" id="L163">			verticesWeightsReader.accept(weight, v);</span>
		}

<span class="fc" id="L166">		String edgesNumLine = next.get();</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">		if (edgesNumLine == null)</span>
<span class="fc" id="L168">			throw new IllegalArgumentException(&quot;invalid edges section&quot;);</span>
		final int m;
		try {
<span class="fc" id="L171">			m = Integer.parseInt(edgesNumLine);</span>
<span class="fc" id="L172">		} catch (NumberFormatException e) {</span>
<span class="fc" id="L173">			throw new IllegalArgumentException(&quot;invalid edges section&quot;);</span>
<span class="fc" id="L174">		}</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">		if (m &lt; 0)</span>
<span class="fc" id="L176">			throw new IllegalArgumentException(&quot;invalid edges section. num edges must be &gt;= 0&quot;);</span>

<span class="fc bfc" id="L178" title="All 2 branches covered.">		for (int e = 1; e &lt;= m; e++) {</span>
<span class="fc" id="L179">			String line = next.get();</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">			if (line == null)</span>
<span class="fc" id="L181">				throw new IllegalArgumentException(&quot;Expected more edge lines&quot;);</span>

<span class="fc" id="L183">			int sourceEnd = line.indexOf(' ');</span>
<span class="fc bfc" id="L184" title="All 2 branches covered.">			if (sourceEnd == -1)</span>
<span class="fc" id="L185">				throw new IllegalArgumentException(&quot;edge line error. Expected 'source target twinEdge weight'&quot;);</span>
<span class="fc" id="L186">			int targetEnd = line.indexOf(' ', sourceEnd + 1);</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">			if (targetEnd == -1)</span>
<span class="fc" id="L188">				throw new IllegalArgumentException(&quot;edge line error. Expected 'source target twinEdge weight'&quot;);</span>
<span class="fc" id="L189">			int twinEdgeEnd = line.indexOf(' ', targetEnd + 1);</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">			if (twinEdgeEnd == -1)</span>
<span class="fc" id="L191">				throw new IllegalArgumentException(&quot;edge line error. Expected 'source target twinEdge weight'&quot;);</span>

			int source, target, twinEdge;
			try {
<span class="fc" id="L195">				source = Integer.parseInt(line.substring(0, sourceEnd));</span>
<span class="fc" id="L196">			} catch (NumberFormatException ex) {</span>
<span class="fc" id="L197">				throw new IllegalArgumentException(&quot;edge line error. Invalid source vertex number&quot;);</span>
<span class="fc" id="L198">			}</span>
			try {
<span class="fc" id="L200">				target = Integer.parseInt(line.substring(sourceEnd + 1, targetEnd));</span>
<span class="fc" id="L201">			} catch (NumberFormatException ex) {</span>
<span class="fc" id="L202">				throw new IllegalArgumentException(&quot;edge line error. Invalid target vertex number&quot;);</span>
<span class="fc" id="L203">			}</span>
			try {
<span class="fc" id="L205">				twinEdge = Integer.parseInt(line.substring(targetEnd + 1, twinEdgeEnd));</span>
<span class="fc" id="L206">			} catch (NumberFormatException ex) {</span>
<span class="fc" id="L207">				throw new IllegalArgumentException(&quot;edge line error. Invalid twin edge number&quot;);</span>
<span class="fc" id="L208">			}</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">			if (twinEdge != 0)</span>
<span class="fc" id="L210">				throw new IllegalArgumentException(&quot;twin edges are not supported&quot;);</span>

<span class="fc bfc" id="L212" title="All 4 branches covered.">			if (line.indexOf(&quot;|{&quot;, twinEdgeEnd + 1) != twinEdgeEnd + 1 || !line.endsWith(&quot;}|&quot;))</span>
<span class="fc" id="L213">				throw new IllegalArgumentException(&quot;edge line error. Invalid weight, expected format: |{weight}|'&quot;);</span>
<span class="fc" id="L214">			String weight = line.substring(twinEdgeEnd + 3, line.length() - 2);</span>

<span class="fc" id="L216">			builder.addEdge(source, target, e);</span>
<span class="fc" id="L217">			edgesWeightsReader.accept(weight, e);</span>
		}

<span class="fc bfc" id="L220" title="All 2 branches covered.">		if (next.get() != null)</span>
<span class="fc" id="L221">			throw new IllegalArgumentException(&quot;unexpected lines after edges section&quot;);</span>

<span class="fc" id="L223">		return builder;</span>
	}

	private static Class&lt;?&gt; ledaTypeStrToClass(String weightsType) {
<span class="fc bfc" id="L227" title="All 11 branches covered.">		switch (weightsType) {</span>
			case &quot;void&quot;:
<span class="fc" id="L229">				return null;</span>
			case &quot;byte&quot;:
<span class="fc" id="L231">				return byte.class;</span>
			case &quot;short&quot;:
<span class="fc" id="L233">				return short.class;</span>
			case &quot;int&quot;:
<span class="fc" id="L235">				return int.class;</span>
			case &quot;long&quot;:
<span class="fc" id="L237">				return long.class;</span>
			case &quot;float&quot;:
<span class="fc" id="L239">				return float.class;</span>
			case &quot;double&quot;:
<span class="fc" id="L241">				return double.class;</span>
			case &quot;bool&quot;:
<span class="fc" id="L243">				return boolean.class;</span>
			case &quot;char&quot;:
<span class="fc" id="L245">				return char.class;</span>
			case &quot;string&quot;:
<span class="fc" id="L247">				return String.class;</span>
			default:
<span class="fc" id="L249">				throw new IllegalArgumentException(&quot;unsupported weights type: &quot; + weightsType);</span>
		}
	}

	private static ObjIntConsumer&lt;String&gt; weightsReader(IWeights&lt;?&gt; weights) {
<span class="fc bfc" id="L254" title="All 2 branches covered.">		if (weights == null) {</span>
<span class="fc" id="L255">			return (weight, id) -&gt; {</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">				if (!weight.isEmpty())</span>
<span class="fc" id="L257">					throw new IllegalArgumentException(&quot;void weights must be empty string&quot;);</span>
<span class="fc" id="L258">			};</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">		} else if (weights instanceof IWeightsByte) {</span>
<span class="fc" id="L260">			IWeightsByte weights0 = (IWeightsByte) weights;</span>
<span class="fc" id="L261">			return (weight, id) -&gt; weights0.set(id, Byte.parseByte(weight));</span>

<span class="fc bfc" id="L263" title="All 2 branches covered.">		} else if (weights instanceof IWeightsShort) {</span>
<span class="fc" id="L264">			IWeightsShort weights0 = (IWeightsShort) weights;</span>
<span class="fc" id="L265">			return (weight, id) -&gt; weights0.set(id, Short.parseShort(weight));</span>

<span class="fc bfc" id="L267" title="All 2 branches covered.">		} else if (weights instanceof IWeightsInt) {</span>
<span class="fc" id="L268">			IWeightsInt weights0 = (IWeightsInt) weights;</span>
<span class="fc" id="L269">			return (weight, id) -&gt; weights0.set(id, Integer.parseInt(weight));</span>

<span class="fc bfc" id="L271" title="All 2 branches covered.">		} else if (weights instanceof IWeightsLong) {</span>
<span class="fc" id="L272">			IWeightsLong weights0 = (IWeightsLong) weights;</span>
<span class="fc" id="L273">			return (weight, id) -&gt; weights0.set(id, Long.parseLong(weight));</span>

<span class="fc bfc" id="L275" title="All 2 branches covered.">		} else if (weights instanceof IWeightsFloat) {</span>
<span class="fc" id="L276">			IWeightsFloat weights0 = (IWeightsFloat) weights;</span>
<span class="fc" id="L277">			return (weight, id) -&gt; weights0.set(id, Float.parseFloat(weight));</span>

<span class="fc bfc" id="L279" title="All 2 branches covered.">		} else if (weights instanceof IWeightsDouble) {</span>
<span class="fc" id="L280">			IWeightsDouble weights0 = (IWeightsDouble) weights;</span>
<span class="fc" id="L281">			return (weight, id) -&gt; weights0.set(id, Double.parseDouble(weight));</span>

<span class="fc bfc" id="L283" title="All 2 branches covered.">		} else if (weights instanceof IWeightsBool) {</span>
<span class="fc" id="L284">			IWeightsBool weights0 = (IWeightsBool) weights;</span>
<span class="fc" id="L285">			return (weight, id) -&gt; weights0.set(id, Boolean.parseBoolean(weight));</span>

<span class="fc bfc" id="L287" title="All 2 branches covered.">		} else if (weights instanceof IWeightsChar) {</span>
<span class="fc" id="L288">			IWeightsChar weights0 = (IWeightsChar) weights;</span>
<span class="fc" id="L289">			return (weight, id) -&gt; weights0.set(id, GraphIoUtils.parseChar(weight));</span>
		} else {
			@SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L292">			IWeightsObj&lt;String&gt; weights0 = (IWeightsObj&lt;String&gt;) weights;</span>
<span class="fc" id="L293">			return (weight, id) -&gt; weights0.set(id, weight);</span>
		}
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>